---
title: "A coupling algorithm for quotes and trades streams"
author: "Petr Fedorov"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    number_sections: FALSE
    figure_captions: TRUE
bibliography: coupling.bib    
---


# The continous-time double auction and LOB

Today, most liquid markets – including stocks, futures, and foreign exchange – are electronic, and adopt a continuous-time double auction mechanism using a limit order book (LOB), in which a transaction occurs whenever a buyer and a seller agree on a price[@bouchaud_trades_2018]. Cryptocurrenices are not exception. 

The mechanics of the countinous double auction or LOB trading may be briefly described as follows: 

1. Traders submit *limit orders* also called *quotes* and *market* or *market-limit* orders (i.e. quotes with the limit price better than the opposite quote best price already in LOB) 
2. *Market* or *market-limit* orders are [matched](https://www.investopedia.com/terms/m/matchingorders.asp) with *quotes*  and executed to produce *trades*.
3. Unmatched *quotes* or unmatched amounts of *market-limit* orders reside in LOB's queues until matched with another *market* or *market-limit* order or cancelled by the participant who placed it.

Market or market-limit orders are also often called the *aggressing* orders while the limit orders sitting in queues are called *resting* orders.

Note that not all matched orders are executed and produce trades. This happens due to self-match or self-trade prevention rules. See for example [CME Globex Self-Match Prevention](https://www.cmegroup.com/globex/trade-on-cme-globex/self-match-faq.html) or [Coinbase Markets Trading Rules 2.4 Self-trade prevention](https://www.coinbase.com/legal/trading_rules).

Thus in order to reconstruct the dynamics of the trading process and order book one needs  information about submitted quotes, market and market-limit orders and trades produced. As we will see below this information is not always provided by exchanges.


# The available data sets

Most of the data sets containing information about quotes and trades consist of two separate loosely coupled files: a **trades** file recording  trades and an **quotes** file recording quote placement, changes and cancellations. Loosely coupled in this context means that records in **trades** file do not always have a clearly identifiable corresponding records in **quotes** file as one would expect since by definition every trade shoud change some quote(s). So some matching or *coupling* procedure is usually required in order to establish such a link between the **trades** and **quotes** files. This link is necessary to:

* Distinguish between quote changes due to limit order cancellations and market order executions
* Estimate the size of market orders placed 
* Distinquish between limit order placements and market limit order placements

and, overall, to achieve the ultimate goal - to perform a complete order book reconstruction at every moment of time.

A recently published book [@abergel_limit_2016] uses the [Thomson Reuters Tick History (TRTH)](https://www.refinitiv.com/en/financial-data/market-data/tick-history) database tells us that

> Because one cannot distinguish market orders from cancellations just by observing changes in the limit order book (the “event” file), and since, the timestamps of the “trade” and “event” files are asynchronous, we use a matching procedure to reconstruct the order book events.

The reported matching rate of the above procedure is about 85% for CAC 40 stocks and as a byproduct the procedure outputs the sign of each matched trade, that is whether it is buyer or seller initiated. Note that TRTH data set does not even provide information about trade direction, it has to be deduced!

The description of similar issues we find in [@hautsch_modelling_2004]:

> A typical problem occurs when trades and quotes are recorded in separate trade and quote databases, like, for example, in the Trade and Quote (TAQ) database released by the NYSE. In this case, it is not directly identifiable whether a quote which has been posted some seconds before a transaction was already valid at the corresponding trade.

[Websocket API v2](https://www.bitstamp.net/websocket/v2/) of the cryptocurrency exchange Bitstamp give access the following information for every instrument traded in the real-time (i.e. for every event):

 * **Live ticker** channel - information about trades. Unique ids of participating quote and market order are provided for each trade.
 * **Live orders** channel - information about quotes and market orders (order creation, change and deletion event).

As we will see later, events in these channels are not always sent in correct time order. Also timestamps in Live tickers and Live orders channels are not synchronized: market order, changes of quotes and market order itself caused by execution of the market order and trades produced all may have different timestamps. Substantial amount of matched orders are not executed due to [self-trade prevention](https://www.reddit.com/r/Bitstamp/comments/bbvut2/bitstamp_api_behaviour/?utm_source=share&utm_medium=web2x) policy of Bitstamp.
 

Similarly [Websocket API version 2.0] of the cryptocurrency exchange Bitfinex have the following channels (for every instrument traded):

 * **Trades** channel - information about trades. Ids of participating quote and market orders are not reported
 * **Raw book** channel - provides information about 100 best bid and 100 ask quotes. Market orders are not reported. Quotes reported as deleted when they fall beyond 100+ best quotes and created again with the same id when they return back. What was happening to them between these moments is not known. Since Bitfinex allows traders to change the price and volume of submitted quotes, the quotes may be changed or just cancelled. 
 
As well as at Bitstamp, events in Trades and Raw book channels are not synchronized.

It should be clear from the short descriptions above that substantial effort is required to reconstruct from these data the true dynamics of order submission, matching and execution from the supplied data.

# The coupling problem

## Definitions

Consider the definition given in [@bouchaud_trades_2018]:


> An order is a commitment, declared at a given submission time, to buy or sell a given volume of an asset at no worse than a given price. An order $x$ is thus described by four attributes:
>
> * its sign (or direction) $\epsilon = \pm 1$, ($\epsilon_x = +1$ for buy orders; $\epsilon_x = −1$ for sell orders),
  * its price $p_x$ ,
  * its volume $v_x > 0$, and
  * its submission time $t_x$.
>  
> We introduce the succinct notation $x := (\epsilon_x , p_x ,v_x, t_x )$.

The authors then continue with the description of what they call The Trade-Matching Algorithm:

> Whenever a trader submits a buy (respectively, sell) order $x$, an LOB’s *trade-matching algorithm* checks whether it is possible for $x$ to match to existing sell (respectively,buy)orders $y$ such that $p_y \leq p_x$ (respectively, $p_y \geq p_x$). If so, the matching occurs immediately and the relevant traders perform a trade for the agreed amount at the agreed price. Any portion of $x$ that does not match instead becomes active at the price $p_x$, and it remains active until either it matches to an incoming sell (respectively, buy) order or it is cancelled. Cancellation usually occurs when the owner of an order no longer wishes to offer a trade at the stated price.

The above descriptions are incomplete:

* According to the definition, an order seems to be an immutable entity but according the descprition of the Trade-Matching algorithm, a portion of $x$ may become 'active' and it is not clear how the quality of being 'active' is different from the mere existence since submitted orders are matched to existing orders,

* At what price traders perform trade - $p_x$ or $p_y$ - is not explicitly stated,

* It is not said what will happen if $v_x \leq v_y$, etc. 

Surprisingly, an order itself and operations of continous double auction appear to be rather complicated things if one attempts to define them rigorously. We will do that below assuming that we have a single instrument and a single currency.



```{definition, name="Order", label=order}
A vector-valued function $\mathbf{o}^i: \mathbb{R}_{>0} \rightarrow \mathbb{R}_{>0} \times \mathbb{R}$ representing a commitment to buy or sell a given volume $v$ of an asset at no worse than a given price $p$ at a particular time $t$ is called an *order* and $i \in \mathbb{Z}$ is called an *unique order identification*. Suppose that:

a. $\mathcal{T^i}$ is a set of intervals $\mathcal{T^i} = \{T_k^i\}_{k=0}^{N^i}$ called *order intervals* where each $T_k^i$ is either a proper interval with endpoints $s_k^i \in \mathbb{R}_{>0}$, $e_k^i \in \mathbb{R}_{>0} \cup \{+\infty\}$, $s_k^i < e_k^i$  or a degenerate interval $\{s_k^i\}, s_k^i \in \mathbb{R}_{>0}$ and $\forall m \neq n : T_m^i \cap T_n^i = \emptyset$

b. $\chi_{T_k^i} : \mathbb{R} \mapsto \{0,1\}$ is an indicator function of sets in $\mathcal{T^i}$: 
$\chi_{T_k^i}(t) = \begin{cases} 1, & t \in T_k^i \\ 0, & \text{otherwise} \end{cases}$.

b. $\mathcal{P}^i = \{p_k^i\}_{k=0}^{N^i}$ is a set of constants called *order prices*, such that $p_k^i \in \mathbb{R}_{>0}$.

c. $\mathcal{V}^i = \{v_k^i\}_{k=0}^{N^i}$ is a set of constants called *order volumes*, such that either $\forall k : v_k^i \in \mathbb{R}_{<0}$ and in this case the order is a commitment to *sell* and is called *sell order* or $\forall k:  v_k^i \in \mathbb{R}_{>0}$ and in this case the order is a commitment to *buy* and is callded *buy order*.
  
d. Sets $\mathcal{P}^i$ and $\mathcal{V}^i$  satisfy the following condition $\forall k < N^i : (p_k^i, v_k^i) \neq (p_{k+1}^i, v_{k+1}^i)$.

Then function $\mathbf{o}^i(t)$ is defined as follows:
$$
  \mathbf{o}^i(t) = (p^i(t), v^i(t)) = \Big( \sum_{k=1}^{N^i} p_k^i \chi_{T_k^i}(t),  \sum_{k=1}^{N^i} v_k^i \chi_{T_k^i}(t) \Big)
$$
  
```

Now we can define

```{definition, name="Order Volume", label=order-volume}
The function $v^i(t)$ in the definition \@ref(def:order) is called an *order volume*.
```

```{definition, name="Filled Volume", label=fill-volume}
The filled volume $f^i(t)$ of an order $i$ at time $t$ is defined as: 
  $$
  f^i(t) = v^i(t) - \lim_{t^{'} \downarrow t} v^i(t^{'})
  $$
  
```

```{definition, name="Cancelled Volume", label=cancelled-volume}
The cancelled volume $c^i(t)$ of an order $i$ at time $t$ is defined as: 
  $$
  c^i(t) = \lim_{t^{'} \uparrow t} v^i(t^{'}) - v^i(t)
  $$
  
```



```{definition, name="Order Price", label=order-price}
The function $p^i(t)$ in the definition \@ref(def:order) is called an *order price*.
```

```{definition, name="Best Bid Price", label=best-bid-price}
Suppose we are given a set of orders $\mathcal{L} = \{\mathbf{o}^i\}$. A (possibly empty) subset $\mathcal{B} =\{\mathbf{o}^b\}_{v_k^b > 0} \subset \mathcal{L}$ of buy orders is called *bids* and the function $b(t)$ is defined as:
  $$
  b_{\mathcal{L}}(t) = \begin{cases} \max_{\mathbf{o}^b \in \mathcal{B}} p^b(t), & \text{ if } \mathcal{B} \neq \emptyset \\0, & \text{ otherwise }  \end{cases}
  $$ is called *best bid price*.
```


```{definition, name="Best Ask Price", label=best-ask-price}
Suppose we are given a set of orders $\mathcal{L} = \{\mathbf{o}^i\}$. A (possibly empty) subset $\mathcal{A} =\{\mathbf{o}^a\}_{v_k^a < 0} \subset \mathcal{L}$ of sell orders is called *asks* and the function $a(t)$ is defined as:
  $$
  a_{\mathcal{L}}(t) = \begin{cases} \min_{\mathbf{o}^a \in \mathcal{A}} p^a(t) & \text{ if } \mathcal{A} \neq \emptyset \\ +\infty, & \text{ otherwise } \end{cases}
  $$ is called *best ask price*.
```

```{definition, name="Matched Orders", label=match}
A buy order $\mathbf{o}^b$ and a sell order $\mathbf{o}^s$ are called *matched* if $\exists t : p^b(t) \geq p^s(t)$. If $$\lim_{t^{'} \uparrow t} p^s(t) \neq p^s(t)$$ then $\mathbf{o}^s$ is called an *agressing* order and $\mathbf{o}^b$ is called a *resting* order. Otherwise, $\mathbf{o}^b$ is called an *agressing* order and $\mathbf{o}^s$ is called a *resting* order.
The set of matched buy orders at time $t$ we will denote $\mathcal{M}_{\text{bid}}(t)$ and the set of matched sell orders - $\mathcal{M}_{\text{ask}}(t)$.
```


```{definition, name="Trade", label=trade}
Suppose a buy order $\mathbf{o}^b$ is matched to a sell order $\mathbf{o}^s$ at time $t$. Let $f$ be the fill at time $t$ of the resting order, $p$ be the price at time $t$ of the resting order. Let $d$ called *direction* be equal to $1$ if the resting order is a buy order and $-1$ otherwise.  Then the tuple $(t, b, s, f, d)$ is called *trade*.

```


```{definition, name="Ideal Order Book", label=iob}
Suppose we are given a set of orders $\mathcal{L} = \{\mathbf{o}^i\}$. We will call  $\mathcal{L}$ an *Ideal Order Book (IOB)* if the following conditions are satisfied: 
  
  a. Instantaneous Match Execution
$$ \lambda \Big( \{t : b_{\mathcal{L}}(t) \geq a_{\mathcal{L}}(t)\}\Big) = 0
(\#eq:instant-trade)
  $$ where $\lambda(X)$ is the Lebesgue measure of set $X$.
  b. Volume Conservation 
  $$
    \forall t \in \{t : b_{\mathcal{L}}(t) \geq a_{\mathcal{L}}(t)\} : \sum_{\mathbf{o}^b(t) \in \mathcal{M}_{\text{bid}}(t)} f^b(t) = \sum_{\mathbf{o}^s(t) \in \mathcal{M}_{\text{ask}}(t)} |f^s(t)|
    $$

```



## Algorithm

Formally speaking, the coupling algorithm is supposed to produce an Ideal Order Book from non-ideal data provided by an exchange.  The efforts required varies by exchange. For example [MOEX](https://www.moex.com/) provides data of almost ideal quality while [Bitfinex](https://www.moex.com/) does not report market orders and order ids for trades.

TBD



# References






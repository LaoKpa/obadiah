---
title: "A coupling algorithm for quotes and trades streams"
author: "Petr Fedorov"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    number_sections: FALSE
    figure_captions: TRUE
bibliography: coupling.bib    
---


# The continous-time double auction and LOB

Today, most liquid markets – including stocks, futures, and foreign exchange – are electronic, and adopt a continuous-time double auction mechanism using a limit order book (LOB), in which a transaction occurs whenever a buyer and a seller agree on a price[@bouchaud_trades_2018]. Cryptocurrenices are not exception. 

The mechanics of the countinous double auction or LOB trading may be briefly described as follows: 

1. Traders submit *limit orders* also called *quotes* and *market* or *market-limit* orders (i.e. quotes with the limit price better than the opposite quote best price already in LOB) 
2. *Market* or *market-limit* orders are [matched](https://www.investopedia.com/terms/m/matchingorders.asp) with *quotes*  and executed to produce *trades*.
3. Unmatched *quotes* or unmatched amounts of *market-limit* orders are resides in LOB's queues until matched with another *market* or *market-limit* order or cancelled by the participant who placed it.

Market or market-limit orders are also often called the *aggressing* orders while the limit orders sitting in queues are called *resting* orders.

Note that not all matched orders are executed and produce trades. This happens due to self-match or self-trade prevention rules. See for example [CME Globex Self-Match Prevention](CME Globex Self-Match Prevention) or [Coinbase Markets Trading Rules 2.4 Self-trade prevention](https://www.coinbase.com/legal/trading_rules).

Thus in order to reconstruct the dynamics of the trading process and order book one needs  information about submitted quotes, market and market-limit orders and trades produced. As we will see below this information is not always provided by exchanges.


# The available data sets

Most of the data sets containing information about quotes and trades consist of two separate loosely coupled files: a **trades** file recording  trades and an **quotes** file recording quote placement, changes and cancellations. Loosely coupled in this context means that records in **trades** file do not always have a clearly identifiable corresponding records in **quotes** file as one would expect since by definition every trade shoud change some quote(s). So some matching or *coupling* procedure is usually required in order to establish such a link between the **trades** and **quotes** files. This link is necessary to:

* Distinguish between quote changes due to limit order cancellations and market order executions
* Estimate the size of market orders placed
* Distinquish between limit order placements and market limit order placements

and, overall, to achieve the ultimate goal - to perform a complete order book reconstruction at every moment of time.

A recently published book [@abergel_limit_2016] uses the [Thomson Reuters Tick History (TRTH)](https://www.refinitiv.com/en/financial-data/market-data/tick-history) database tells us that

> Because one cannot distinguish market orders from cancellations just by observing changes in the limit order book (the “event” file), and since, the timestamps of the “trade” and “event” files are asynchronous, we use a matching procedure to reconstruct the order book events.

The reported matching rate of the above procedure is about 85% for CAC 40 stocks and as a byproduct the procedure outputs the sign of each matched trade, that is whether it is buyer or seller initiated. Note that TRTH data set does not even provide information about trade direction, it has to be deduced!

The description of similar issues we find in [@hautsch_modelling_2004]:

> A typical problem occurs when trades and quotes are recorded in separate trade and quote databases, like, for example, in the Trade and Quote (TAQ) database released by the NYSE. In this case, it is not directly identifiable whether a quote which has been posted some seconds before a transaction was already valid at the corresponding trade.

[Websocket API v2](https://www.bitstamp.net/websocket/v2/) of the cryptocurrency exchange Bitstamp give access the following information for every instrument traded in the real-time (i.e. for every event):

 * **Live ticker** channel - information about trades. Unique ids of participating quote and market order are provided for each trade.
 * **Live orders** channel - information about quotes and market orders (order creation, change and deletion event).

As we will see later, events in these channels are not always sent in correct time order. Also timestamps in Live tickers and Live orders channels are not synchronized: market order, changes of quotes and market order itself caused by execution of the market order and trades produced all may have different timestamps. Substantial amount of matched orders are not executed due to [self-trade prevention](https://www.reddit.com/r/Bitstamp/comments/bbvut2/bitstamp_api_behaviour/?utm_source=share&utm_medium=web2x) policy of Bitstamp.
 

Similarly [Websocket API version 2.0] of the cryptocurrency exchange Bitfinex have the following channels (for every instrument traded):

 * **Trades** channel - information about trades. Ids of participating quote and market orders are not reported
 * **Raw book** channel - provides information about 100 best bid and 100 ask quotes. Market orders are not reported. Quotes reported as deleted when they fall beyond 100+ best quotes and created again with the same id when they return back. What was happening between these moments is not known.
 
As well as at Bitstamp, events in Trades and Raw book channels are not synchronized.

It should be clear from the short descriptions above that the substantial efforts are required in order to reconstruct from these data the true dynamics of order submission, matching and execution.

# The coupling algorithm

From the first glance, an order is a rather simple thing. Consider, for example, the definition given in [@bouchaud_trades_2018]:


> An order is a commitment, declared at a given submission time, to buy or sell a given volume of an asset at no worse than a given price. An order $x$ is thus described by four attributes:
>
> * its sign (or direction) $\epsilon = \pm 1$, ($\epsilon_x = +1$ for buy orders; $\epsilon_x = −1$ for sell orders),
  * its price $p_x$ ,
  * its volume $v_x > 0$, and
  * its submission time $t_x$.
>  
> We introduce the succinct notation $x := (\epsilon_x , p_x ,v_x, t_x )$.

Incompleteness of this definition will become obvious if one asks whether this commitment holds indefinitely or for a limited period of time  or whether the volume of an order remains the same or changes, etc. Surprisingly, an order appears to be a rather complicated entity if you want to define it rigorously as we do below. We assume that we have a single instrument and a single currency.

```{definition, name="Order-related event", label=order-event}
A tuple of four numbers $(t^i, n^i, p^i, v^i)$  where (superscript $i$ is assumed)

 a. $t \in \mathbb{R}_{>0}$ is a timestamp or a moment in time when the event has happened 
 b. $n \in \mathbb{R}_{>0} \cup \{-\infty\, +\infty\}$ is a timestamp of the next (see definition \@ref(def:order-life-cycle)) event  with the same $i$ or $\pm \infty$ if there is no such event
 c. $\forall n \neq -\infty: t \leq n$
 d. $p \in \mathbb{R}_{> 0}$
 e. $v \in \mathbb{R}$
   
is called an *event, related to order* $i$ or an *order-related event* or simply an *event*. Here $i$ is an unique order identification (it may be assumed that $i \in \mathbb{Z}$), $t$  , $n$ , $p$ is a price, $v$ is a volume.

We will sometimes succintly write the event related to order $i$ as $e^i$.
```



```{definition, name="Order life cycle", label=order-life-cycle}
A set $O^i = \{e_k^i \}_{k = 0}^{k=N^i} = \{ (t_k^i, n_k^i, p_k^i, v_k^i) \}_{k = 0}^{k=N^i}, k \in \mathbb{Z}_{\geq 0}$ of events related to order $i$, where (superscript $i$ is assumed)

 a. $\forall k < N: n_k = t_{k+1} \lor -\infty$
 b. $n_{N} = \pm \infty$
 c. $\forall k_1, k_2, 0 \leq k_1,k_2 \leq N: \text{sgn}(v_{k_1}) = \text{sgn}(v_{k_2})$
 d. $\forall k < N: v_k \neq 0$

is called an *order $i$ life cycle*. We will denote $O^i(t)$ the subset of $O^i$ which satisfies the additional condition:
   
 e. $t_k^i \leq t < n_k^i$
   
Intuitevely, the subset $O^i(t)$ will either include a single event which we will call an *active order at time $t$* or will be empty.
```

Now we can define

```{definition, name="Order Volume", label=order-volume}
An volume of order $i$ is a function of time $t$ defined as follows:
$$
  V_{O^i}(t) = \begin{cases} |v^i_m|, \text{ if } O^i(t) = \{e^i_m\}  \\ 0, \text{ otherwise } \end{cases}
$$
```

Similarly, we define

```{definition, name="Order Price", label=order-price}
A price of order $i$ is a function of time $t$ defined as follows:
$$
  P_{O^i}(t) = \begin{cases} p_m^i, \text{ if } \text{ if } O^i(t) = \{e^i_m\} \\ 
  0, \text{ otherwise }
\end{cases}
$$
```

Note that both $V_{O_i}(t)$ and $P_{O_i}(t)$ are [càdlàg](https://en.wikipedia.org/wiki/C%C3%A0dl%C3%A0g) functions.


```{definition, name="Limit Order Book life cycle", label=lob-life-cycle}
Suppose we are given a set of order life cycles $\mathcal{L} = \{O^i\}$. 

A (possibly empty) subset $\mathcal{B} =\{O^b\}_{v^b_1 > 0} \subset \mathcal{L}$ is called *bids life cycle*. The set $\mathcal{B}(t) =\{O^b(t)\}_{v^b_1 > 0}$ is called active bid orders at time $t$. 

A (possibly empty) subset $\mathcal{A} =\{O^a\}_{v^a_1 < 0} \subset \mathcal{L}$ is called *ask life cycle*. The set $\mathcal{A}(t) =\{O^a(t)\}_{v^a_1 > 0}$ is called active ask orders at time $t$.

We will call  $\mathcal{L}$ a (valid) *Limit Order Book (LOB) life cycle* if the following condition is satisfied: 
$$
\int_{-\infty}^{+\infty} \theta(\max_{O^b \in \mathcal{B} } P_{O^b}(t) - \min_{O^a \in \mathcal{A} } P_{O^a}(t)) dt = 0
$$ where $\theta(x)$ is the [Heaviside step function](https://en.wikipedia.org/wiki/Heaviside_step_function).

```



```{definition, name="Trade event", label=trade-event}
Suppose we are given a LOB life cycle $\mathcal{L}$ and tuple $t^j = (t^j, a^j, r^j, p^j, v^j)$.

If $\exists (O^{a^j} \in \mathcal{A}, O^{r^j} \in \mathcal{B}) \lor (O^{a^j} \in \mathcal{B}, O^{r^j} \in \mathcal{A}) , m, n$ such that:
  
  a. $t^{a^j}_m = t^{r^j}_n = t^j$
  b. $\begin{cases} p_m^{a^j} \geq p_n^{r^j}, \text{ if } O^{a^j} \in \mathcal{B}, O^{r^j} \in \mathcal{A}\\
p_m^{a^j} \leq p_n^{r^j}, \text{ if } O^{a^j} \in \mathcal{A}, O^{r^j} \in \mathcal{B} \end{cases}$ 
  c. $p^{r^j}_n = p^j$
  d. $|v_{m-1}^{a^j}| - |v_m^{a^j}| = |v_{n-1}^{r^j}| - |v_n^{r^j}| = v^j$,

we will call the tuple $t^j$ a *trade event*. Here $j$ is an unique trade event identificator (it may be assumed that $j \in \mathbb{Z}$), $a^j$ is an aggressing order, $r^j$ is a resting order, which determines the price $p^j$ of the trade event. It is said that orders $a^j$ and $r^j$ are *matched* and *executed* to produce a trade event. Note that not all matched orders are automatically executed. They may be cancelled too in case both orders are placed by the same trader.
```






# References





